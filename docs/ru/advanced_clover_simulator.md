# Advanced Clover Simulator

[CopterHack-2022](copterhack2022.md), команда **FTL**.

[Ссылка на проект](https://github.com/FTL-team/clover_sim)

## Информация о команде

```cpp
#include "intrestingCommandDescription.h"
```

Состав команды:

* Максим Романовский, [@maximmasterr](https://t.me/maximmasterr), капитан, программист.
* Михаил Кулик, [@mkulik05](https://t.me/mkulik05), программист.

Страна: Беларусь

## Описание проекта

Разработка симулятора для clover с возможностью создания workspace(окружения позволяющие легко управлять и транспортировать файлы симулятора такие как: проекты, конфигурацииб установленные пакеты).

* Простой, быстрый и производительный способо запуска симулятора
* Инструментарий для создания заданий (как на [IOR2020](https://clover.coex.tech/ru/innopolis_open_L22_AERO.html))
* Изоляция Gazebo и чекера заданий от Workspace пользователя и clover
* Worker для проверки задач со степика
* Возможность запуска несколько коптеров каждый из которых имеет свой контейнер
* Полная симуляция raspberry с помощью qemu (включая GPIO, USB и камеру)

### Использование платформы "Клевер"

Данный проект является набором инструментов для запуска симуляторов Клевера

## Первые пуски

Для начала мы решили разработать симулятор имеющий такой же функционал как и [виртуальная машна](./simulation_vm.md)

В качестве инструменты для запуска контейнеров мы используем `systemd-nspawn` ([read more](https://wiki.archlinux.org/title/systemd-nspawn)), так как он запускает systemd init и позволяет пользоваться `systemctl`, так как: не эмулируется ядро линукс, отсутствует ограничение на процессор и память, производиельность такого метода выше чем у виртуальной машиныю.

С графикой посложнее, в виртуальной машине используется графика от VMware, однако в случае если мы не эмулируем ядро мы могли бы пробросить видеокарту. В отличии от виртуальной машины видеокарта останется доступна в хост машине, однако данный метод требует что бы внутри были установлены такие же драйвера как и в хосте(привет NVIDIA). По этому мы используеем `virgl` ([read more](https://gitlab.freedesktop.org/virgl/virglrenderer)), а точнее [virgl_test_server](https://gitlab.freedesktop.org/virgl/virglrenderer/-/wikis/vtest). Virgl представляет собой очень производительный способ проброса opengl(и vulkan). Из-за бага в mesa требуется чтобы стояла mesa 21, для этого мы добавляем ppa [kisak-mesa](https://launchpad.net/~kisak/+archive/ubuntu/kisak-mesa). Работает это примерно так: virgl_test_server создаёт unix-сокет, он пробрасывается в контейнер, mesa в контейнере отправляет запросы на рендер в этот сокет,  virgl принимает их и транслирует в видеокарту, результат отображается на экране. Такой способ позволяет получить более 120fps в Gazebo.

Для реализации механизма workspace, мы используем [overlayfs](https://wiki.archlinux.org/title/Overlay_filesystem), она позволяет создать фс в которой файлы модифицируются и читаются в "верхней" файловой системе, а за тем по порядку в нижних. Таким образом у нас есть директория base которая хранит внутри симулятор, ubuntu, clover. А workspace являются папки поверх base которые хранят только изменения что позволяет сильно экономить место. Workspace можно быстро создавать и удалять, экспортировать и импортировать.

Для сборки base мы используем GitHub actions, [здесь](https://GitHub.com/FTL-team/clover_sim_basefs) находится репозиторй со скриптами, из интересного можно отметить то что требуется прописать в `/etc/resolv.conf` dns-серверы, прописать нормальный hostname в `/etc/hostname`(иначе debootstrap скопирует его с runner-а GitHub, и оно будет странным) и прописать в `/etc/hosts` строку для резолва этого имени на `127.0.0.1` иначе ROS не запустится.

Для того чтобы было всё красиво и удобно мы создали [инструмент](https://github.com/FTL-team/clover_sim) на go, который занимается управлением workspace-ами и запуском симулятора.

При попытке запуска симулятора проиходило полное поглащение оперативной памяти и swap, а это 8+32 гигабайта. В чём же дело? А в том, что rosout для того чтобы проверить не упрётся ли оно в лимит файловых дескрипторов... аллоцирует их все :/ Гениальное решение. Решается добавление лимитов в `/etc/security/limits.d/30-nofilelimit.conf`. [Более подробно здесь](https://answers.ros.org/question/336963/rosout-high-memory-usage/)
